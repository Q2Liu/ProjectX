-- =====================================================
-- 简化版本：给admin用户分配角色
-- 只使用基础字段，避免列不存在的错误
-- =====================================================

-- 1. 检查sys_user_roles表结构
SELECT 'sys_user_roles_structure' as info_type;
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns 
WHERE table_name = 'sys_user_roles' 
  AND table_schema = 'public'
ORDER BY ordinal_position;

-- 2. 检查所有可用角色
SELECT 'available_roles' as info_type,
    id,
    code,
    name
FROM sys_roles
ORDER BY code;

-- 3. 检查admin用户ID
SELECT 'admin_user_info' as info_type,
    id,
    username,
    status
FROM sys_users 
WHERE username = 'admin';

-- 4. 删除admin用户现有的角色分配
DELETE FROM sys_user_roles WHERE user_id = (SELECT id FROM sys_users WHERE username = 'admin');

-- 5. 简化的角色分配（只使用必需字段）
DO $$
DECLARE
    admin_user_id VARCHAR(64);
    role_record RECORD;
    assignment_count INTEGER := 0;
    has_assigned_at BOOLEAN;
    has_assigned_by BOOLEAN;
BEGIN
    -- 获取admin用户ID
    SELECT id INTO admin_user_id FROM sys_users WHERE username = 'admin';
    
    IF admin_user_id IS NULL THEN
        RAISE EXCEPTION 'Admin user not found';
    END IF;
    
    -- 检查sys_user_roles表的列
    SELECT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'sys_user_roles' AND column_name = 'assigned_at'
    ) INTO has_assigned_at;
    
    SELECT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'sys_user_roles' AND column_name = 'assigned_by'
    ) INTO has_assigned_by;
    
    RAISE NOTICE 'sys_user_roles表结构: assigned_at=%, assigned_by=%', has_assigned_at, has_assigned_by;
    
    -- 分配所有角色给admin用户
    FOR role_record IN 
        SELECT id, code, name 
        FROM sys_roles 
        ORDER BY code
    LOOP
        BEGIN
            -- 根据表结构使用不同的INSERT语句
            IF has_assigned_at AND has_assigned_by THEN
                INSERT INTO sys_user_roles (
                    id, user_id, role_id, assigned_at, assigned_by
                ) VALUES (
                    'ur-admin-' || role_record.id,
                    admin_user_id,
                    role_record.id,
                    CURRENT_TIMESTAMP,
                    'system'
                );
            ELSIF has_assigned_at THEN
                INSERT INTO sys_user_roles (
                    id, user_id, role_id, assigned_at
                ) VALUES (
                    'ur-admin-' || role_record.id,
                    admin_user_id,
                    role_record.id,
                    CURRENT_TIMESTAMP
                );
            ELSE
                INSERT INTO sys_user_roles (
                    id, user_id, role_id
                ) VALUES (
                    'ur-admin-' || role_record.id,
                    admin_user_id,
                    role_record.id
                );
            END IF;
            
            assignment_count := assignment_count + 1;
            RAISE NOTICE '成功分配角色: % (%)', role_record.code, role_record.name;
            
        EXCEPTION 
            WHEN unique_violation THEN
                RAISE NOTICE '角色 % 已经分配', role_record.code;
            WHEN OTHERS THEN
                RAISE NOTICE '分配角色 % 失败: %', role_record.code, SQLERRM;
        END;
    END LOOP;
    
    RAISE NOTICE '总共成功分配了 % 个角色给admin用户', assignment_count;
END $$;

-- 6. 创建基础的SUPER_ADMIN角色（如果需要）
DO $$
DECLARE
    admin_user_id VARCHAR(64);
    super_admin_exists BOOLEAN;
    has_assigned_at BOOLEAN;
    has_assigned_by BOOLEAN;
BEGIN
    SELECT id INTO admin_user_id FROM sys_users WHERE username = 'admin';
    
    -- 检查是否已经有管理员相关角色
    SELECT EXISTS (
        SELECT 1 FROM sys_roles 
        WHERE code IN ('SUPER_ADMIN', 'SYS_ADMIN', 'SYSTEM_ADMIN', 'ADMIN')
    ) INTO super_admin_exists;
    
    IF NOT super_admin_exists THEN
        -- 创建基础的SUPER_ADMIN角色
        INSERT INTO sys_roles (id, code, name) VALUES 
        ('SUPER_ADMIN_ROLE', 'SUPER_ADMIN', 'Super Administrator')
        ON CONFLICT (id) DO NOTHING;
        
        RAISE NOTICE '创建了基础SUPER_ADMIN角色';
        
        -- 检查sys_user_roles表的列
        SELECT EXISTS (
            SELECT 1 FROM information_schema.columns 
            WHERE table_name = 'sys_user_roles' AND column_name = 'assigned_at'
        ) INTO has_assigned_at;
        
        SELECT EXISTS (
            SELECT 1 FROM information_schema.columns 
            WHERE table_name = 'sys_user_roles' AND column_name = 'assigned_by'
        ) INTO has_assigned_by;
        
        -- 分配SUPER_ADMIN角色
        BEGIN
            IF has_assigned_at AND has_assigned_by THEN
                INSERT INTO sys_user_roles (
                    id, user_id, role_id, assigned_at, assigned_by
                ) VALUES (
                    'ur-admin-super-admin',
                    admin_user_id,
                    'SUPER_ADMIN_ROLE',
                    CURRENT_TIMESTAMP,
                    'system'
                );
            ELSIF has_assigned_at THEN
                INSERT INTO sys_user_roles (
                    id, user_id, role_id, assigned_at
                ) VALUES (
                    'ur-admin-super-admin',
                    admin_user_id,
                    'SUPER_ADMIN_ROLE',
                    CURRENT_TIMESTAMP
                );
            ELSE
                INSERT INTO sys_user_roles (
                    id, user_id, role_id
                ) VALUES (
                    'ur-admin-super-admin',
                    admin_user_id,
                    'SUPER_ADMIN_ROLE'
                );
            END IF;
            
            RAISE NOTICE '成功分配SUPER_ADMIN角色给admin用户';
            
        EXCEPTION 
            WHEN OTHERS THEN
                RAISE NOTICE '分配SUPER_ADMIN角色失败: %', SQLERRM;
        END;
    ELSE
        RAISE NOTICE 'SUPER_ADMIN相关角色已存在，跳过创建';
    END IF;
END $$;

-- 7. 验证最终结果
SELECT 'final_admin_roles' as info_type,
    u.username,
    r.id as role_id,
    r.code as role_code,
    r.name as role_name
FROM sys_users u
JOIN sys_user_roles ur ON u.id = ur.user_id
JOIN sys_roles r ON ur.role_id = r.id
WHERE u.username = 'admin'
ORDER BY r.code;

-- 8. 统计admin用户的角色数量
SELECT 'admin_role_summary' as info_type,
    u.username,
    COUNT(ur.role_id) as total_roles,
    STRING_AGG(r.code, ', ' ORDER BY r.code) as role_codes
FROM sys_users u
LEFT JOIN sys_user_roles ur ON u.id = ur.user_id
LEFT JOIN sys_roles r ON ur.role_id = r.id
WHERE u.username = 'admin'
GROUP BY u.username;

-- 9. 手动分配一些关键角色（如果上面的循环失败）
DO $$
DECLARE
    admin_user_id VARCHAR(64);
    role_id VARCHAR(64);
    has_assigned_at BOOLEAN;
BEGIN
    SELECT id INTO admin_user_id FROM sys_users WHERE username = 'admin';
    
    -- 检查sys_user_roles表的列
    SELECT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'sys_user_roles' AND column_name = 'assigned_at'
    ) INTO has_assigned_at;
    
    -- 手动分配一些关键角色
    FOR role_id IN 
        SELECT id FROM sys_roles 
        WHERE code IN ('SYS_ADMIN_ROLE', 'AUDITOR_ROLE', 'TECH_DIRECTOR_ROLE', 'DEVELOPER_ROLE', 'MANAGER_ROLE')
        OR code LIKE '%ADMIN%'
        OR code LIKE '%SYSTEM%'
        LIMIT 10
    LOOP
        BEGIN
            IF has_assigned_at THEN
                INSERT INTO sys_user_roles (
                    id, user_id, role_id, assigned_at
                ) VALUES (
                    'ur-admin-manual-' || role_id,
                    admin_user_id,
                    role_id,
                    CURRENT_TIMESTAMP
                ) ON CONFLICT (id) DO NOTHING;
            ELSE
                INSERT INTO sys_user_roles (
                    id, user_id, role_id
                ) VALUES (
                    'ur-admin-manual-' || role_id,
                    admin_user_id,
                    role_id
                ) ON CONFLICT (id) DO NOTHING;
            END IF;
            
            RAISE NOTICE '手动分配角色: %', role_id;
            
        EXCEPTION 
            WHEN OTHERS THEN
                RAISE NOTICE '手动分配角色 % 失败: %', role_id, SQLERRM;
        END;
    END LOOP;
END $$;

-- 10. 最终验证
SELECT 'final_verification' as info_type,
    COUNT(*) as total_assigned_roles
FROM sys_user_roles ur
JOIN sys_users u ON ur.user_id = u.id
WHERE u.username = 'admin';

-- =====================================================
-- 使用说明:
-- 
-- 这个脚本会:
-- 1. 显示表结构信息用于调试
-- 2. 尝试分配所有可用角色给admin用户
-- 3. 如果需要，创建SUPER_ADMIN角色
-- 4. 手动分配一些关键的管理员角色
-- 5. 验证最终结果
-- 
-- 执行后:
-- 1. 查看输出中的角色分配数量
-- 2. 重新登录admin用户
-- 3. 检查Admin Center是否显示更多菜单
-- =====================================================
