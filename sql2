-- =====================================================
-- 超简化版本：给admin用户分配角色
-- 只使用最基础的字段，完全避免列不存在的错误
-- =====================================================

-- 1. 首先更新admin用户的密码哈希（确保能登录）
UPDATE sys_users 
SET password_hash = '$2a$10$bTB3yyVtzpJw17uMI9pShOzAkm07MKZa2EyQhc4izBO1MdXXEiUiO'
WHERE username = 'admin';

-- 2. 检查sys_user_roles表的实际结构
SELECT 'sys_user_roles_columns' as info_type,
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns 
WHERE table_name = 'sys_user_roles' 
  AND table_schema = 'public'
ORDER BY ordinal_position;

-- 3. 检查admin用户和所有角色
SELECT 'admin_user' as info_type, id, username FROM sys_users WHERE username = 'admin';
SELECT 'all_roles' as info_type, id, code, name FROM sys_roles ORDER BY code;

-- 4. 删除admin用户现有的角色分配
DELETE FROM sys_user_roles WHERE user_id = (SELECT id FROM sys_users WHERE username = 'admin');

-- 5. 最简化的角色分配（只使用id, user_id, role_id三个基础字段）
DO $$
DECLARE
    admin_user_id VARCHAR(64);
    role_record RECORD;
    assignment_count INTEGER := 0;
BEGIN
    -- 获取admin用户ID
    SELECT id INTO admin_user_id FROM sys_users WHERE username = 'admin';
    
    IF admin_user_id IS NULL THEN
        RAISE NOTICE 'Admin user not found!';
        RETURN;
    END IF;
    
    RAISE NOTICE 'Admin用户ID: %', admin_user_id;
    
    -- 分配所有角色给admin用户（只使用三个基础字段）
    FOR role_record IN 
        SELECT id, code, name 
        FROM sys_roles 
        ORDER BY code
    LOOP
        BEGIN
            -- 只使用最基础的三个字段
            INSERT INTO sys_user_roles (
                id, 
                user_id, 
                role_id
            ) VALUES (
                'ur-admin-' || role_record.id,
                admin_user_id,
                role_record.id
            );
            
            assignment_count := assignment_count + 1;
            RAISE NOTICE '成功分配角色: % (%)', role_record.code, role_record.name;
            
        EXCEPTION 
            WHEN unique_violation THEN
                RAISE NOTICE '角色 % 已经分配', role_record.code;
            WHEN OTHERS THEN
                RAISE NOTICE '分配角色 % 失败: %', role_record.code, SQLERRM;
        END;
    END LOOP;
    
    RAISE NOTICE '总共成功分配了 % 个角色给admin用户', assignment_count;
END $$;

-- 6. 如果上面失败，尝试手动分配几个关键角色
INSERT INTO sys_user_roles (id, user_id, role_id) 
SELECT 
    'ur-admin-manual-' || r.id,
    u.id,
    r.id
FROM sys_users u, sys_roles r
WHERE u.username = 'admin'
  AND r.code IN ('SYS_ADMIN_ROLE', 'AUDITOR_ROLE', 'TECH_DIRECTOR_ROLE', 'DEVELOPER_ROLE', 'MANAGER_ROLE', 'USER_ROLE', 'BUSINESS_USER_ROLE')
ON CONFLICT (id) DO NOTHING;

-- 7. 如果还是没有角色，创建一个基础的ADMIN角色并分配
DO $$
DECLARE
    admin_user_id VARCHAR(64);
    admin_role_count INTEGER;
BEGIN
    SELECT id INTO admin_user_id FROM sys_users WHERE username = 'admin';
    
    -- 检查admin用户是否有角色
    SELECT COUNT(*) INTO admin_role_count
    FROM sys_user_roles 
    WHERE user_id = admin_user_id;
    
    IF admin_role_count = 0 THEN
        RAISE NOTICE 'Admin用户没有角色，创建基础ADMIN角色';
        
        -- 创建基础ADMIN角色
        INSERT INTO sys_roles (id, code, name) VALUES 
        ('BASIC_ADMIN_ROLE', 'ADMIN', 'Administrator')
        ON CONFLICT (id) DO NOTHING;
        
        -- 分配给admin用户
        INSERT INTO sys_user_roles (id, user_id, role_id) VALUES 
        ('ur-admin-basic', admin_user_id, 'BASIC_ADMIN_ROLE')
        ON CONFLICT (id) DO NOTHING;
        
        RAISE NOTICE '创建并分配了基础ADMIN角色';
    END IF;
END $$;

-- 8. 验证最终结果
SELECT 'final_result' as info_type,
    u.username,
    r.code as role_code,
    r.name as role_name
FROM sys_users u
JOIN sys_user_roles ur ON u.id = ur.user_id
JOIN sys_roles r ON ur.role_id = r.id
WHERE u.username = 'admin'
ORDER BY r.code;

-- 9. 统计
SELECT 'summary' as info_type,
    COUNT(*) as total_roles_assigned
FROM sys_user_roles ur
JOIN sys_users u ON ur.user_id = u.id
WHERE u.username = 'admin';

-- 10. 显示admin用户的完整信息
SELECT 'admin_final_info' as info_type,
    u.id,
    u.username,
    u.password_hash,
    u.status,
    COUNT(ur.role_id) as role_count
FROM sys_users u
LEFT JOIN sys_user_roles ur ON u.id = ur.user_id
WHERE u.username = 'admin'
GROUP BY u.id, u.username, u.password_hash, u.status;

-- =====================================================
-- 使用说明:
-- 
-- 这个脚本:
-- 1. 更新admin用户的密码哈希为正确的值
-- 2. 只使用sys_user_roles表的三个基础字段 (id, user_id, role_id)
-- 3. 尝试分配所有现有角色
-- 4. 如果失败，手动分配关键角色
-- 5. 如果还是没有角色，创建基础ADMIN角色
-- 
-- 执行后:
-- 1. 查看输出中分配了多少个角色
-- 2. 重新登录admin用户 (admin/admin123)
-- 3. 检查Admin Center是否显示更多菜单
-- =====================================================
